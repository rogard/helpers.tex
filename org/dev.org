#+title: helpers.tex --- dev.org

Meta file to generate files.

* tex
** license

#+name: tex-license
#+begin_src latex
% -----------------------------------------------------------------
% Copyright (C) 2025-2026 by Erwann Rogard
% - Source repository: https://github.com/rogard/helpers.tex
% - Released under the LaTeX Project Public License v1.3c or later
% - See http://www.latex-project.org/lppl.txt
% -----------------------------------------------------------------
#+end_src

** gotcha
:PROPERTIES:
:header-args: :tangle "../tex/gotcha-solution.tex"
:END:

#+begin_src latex
  % -----------------------------------------------------------------
  % Gotchas with their solutions
  % -----------------------------------------------------------------
#+end_src

*** ~\file_input:n~ breaks expl3

#+begin_src latex
  % ---
  % Gotcha:   \file_input:n breaks expl3 syntax mode
  % Solution: use \ExplSyntaxOff\ExplSyntaxOn after \file_input:n
#+end_src

*** Writing to a non-nested directory

#+begin_src latex
  % ---
  % Gotcha: writing to a non-nested directory
  % Warning:
  %   "pdflatex: Not writing to <path>
  %    (openout_any=p; no extended check)"
  % Solution:
#+end_src

#+begin_src latex
  % % \jobname.tex:
  % \def\snippetpath{\texdir/\jobname-snippet}
  % \begin{filecontents}[overwrite]{\snippetpath.tex}
  % [content]
  % \end{filecontents}
#+end_src

#+header: :noweb-ref tex-snippetpath
#+begin_src latex
  % # shell:
  % cd pdf
  % export TEXMFOUTPUT=$(realpath ../tex)
  % source_file='../tex/<jobname>.tex'
  % pdflatex [-shell-escape] "\\def\\texdir{$TEXMFOUTPUT}\input "\
  % "$source_file"
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-snippetpath
#+begin_src latex
  \def\snippetpath{\texdir/\jobname-snippet}
#+end_src

#+begin_src latex
  % Credits:
  % https://tex.stackexchange.com/a/756108/112708
#+end_src

*** ~\usepackage~ warning about path

#+begin_src latex
  % ---
  % Gotcha:   \usepackage warning about path
  % Code:     \usepackage{../tex/module} 
  % Warning:  You have requested file `../tex/module`,
  %           but the file provides `<module>'
  % Solution: Ignore the warning
#+end_src

** counter
*** source
**** section
***** info

#+name: org-counter-summary
#+begin_src latex
  Counter commands allowing cross-referencing
#+end_src

#+header: :noweb-ref tex-counter-info
#+begin_src latex
  % -----------------------------------------------------------------
#+end_src

#+header: :noweb-ref tex-counter-info
#+begin_src latex
  % Usage:
#+end_src

#+header: :noweb-ref tex-counter-info
#+begin_src latex  
  % \CounterSetup{ new = <name> }
  % \CounterIncrement{ <name> }
  % \CounterUse{ <name> }
  % \CounterLabel{ <name> }{ <label> }
  % \CounterRef{ <name> }{ <label> }
#+end_src

#+header: :noweb-ref tex-counter-info
#+begin_src latex
  % Other:
  % - Compile twice
  % - To start anew, delete `\jobname.aux`
#+end_src

#+header: :noweb-ref tex-counter-info
#+begin_src latex
  % -----------------------------------------------------------------
#+end_src

***** guard

#+header: :noweb-ref tex-counter-guard
#+begin_src latex
  % TODO remove
  %  \tl_if_exist:NTF \g__erw_counter_flag_tl
  %  {%
  %    \msg_warning:nnn { __erw_counter }{ generic }{ already-loaded }
  %    \file_input_stop:
  %  }
  %  {%
  %    \tl_gset:Nn \g__erw_counter_flag_tl{}
  %  }
#+end_src

***** expl3

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \msg_new:nnn{__erw_counter}{generic}{#1}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new:Npn \__erw_counter_name:n
  #1 % string - <name>
  {g__erw_counter_#1_int}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \keys_define:nn{__erw_counter}
  {%
    new.code:n = { \int_gzero_new:c{\__erw_counter_name:n{#1}} }
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new_protected:Npn \__erw_counter_increment:n
  #1 % <string: name>
  {%
    \int_incr:c{\__erw_counter_name:n{#1}}
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new:Npn \__erw_counter_use:n
  #1 % <string: name>
  {%
    \int_use:c{\__erw_counter_name:n{#1}}
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \iow_new:N \g__erw_counter_aux_iow
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \str_const:Ne\c__erw_counter_aux_str
  {\c_sys_jobname_str .erw.counter.aux}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \AtBeginDocument
  {
    \file_if_exist:nTF { \c__erw_counter_aux_str }
    {
      \file_input:n { \c__erw_counter_aux_str }
    }
    {
      \exp_args:NNe
      \iow_open:Nn \g__erw_counter_aux_iow { \c__erw_counter_aux_str }
    }
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \AtEndDocument
  {
    \iow_close:N \g__erw_counter_aux_iow
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new_protected:Npn \__erw_counter_write:nnn
  #1 % <value>
  #2 % <name>
  #3 % <label>
  {
    \iow_now:Nx \g__erw_counter_aux_iow
    {
      \token_to_str:N \ExplSyntaxOn
      \token_to_str:N \__erw_counter_set:nnn { #2 }{ #3 }{ #1 }
      \token_to_str:N \ExplSyntaxOff
    }
  }
  \cs_generate_variant:Nn \__erw_counter_write:nnn{e}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new_protected:Npn \__erw_counter_write:nn
  #1 % <name>
  #2 % <label>
  {%
    \__erw_counter_write:enn{ \__erw_counter_use:n{ #1 } }
    { #1 }
    { #2 }
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new:Npn\__erw_counter_label:nn
  #1 % <name>
  #2 % <label>
  {g__erw_counter_label_#1_#2_tl}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new_protected:Npn \__erw_counter_set:nnn
  #1 % infix
  #2 % label
  #3 % value
  {%
    \exp_args:Ne
    \tl_gset:cn { \__erw_counter_label:nn{ #1 }{ #2 } } { #3 }
  }
  \cs_generate_variant:Nn\__erw_counter_set:nnn{e}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new:Npn \__erw_counter_ref:nn
  #1 % infix
  #2 % label
  {%
    \tl_if_exist:cTF { \__erw_counter_label:nn{ #1 }{ #2 } }
    {%
      \tl_use:c { \__erw_counter_label:nn{ #1 }{ #2 } }
      \msg_note:nnn { __erw_counter } { generic }
      { To~reset~counter~references,~delete~\c__erw_counter_aux_str. }
    }
    { \msg_warning:nnn{__erw_counter}{generic}{Compile~one~more~time} }
  }
#+end_src

***** doc-cmd

#+header: :tangle no
#+header: :noweb-ref tex-counter-doc-cmd
#+begin_src latex
  \ProvideDocumentCommand{\CounterSetup}{m}
  { \keys_set:nn{__erw_counter}{#1} }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-doc-cmd
 #+begin_src latex
  \ProvideDocumentCommand{\CounterIncrement}{m}{\__erw_counter_increment:n{#1}}
  \ProvideDocumentCommand{\CounterUse}{m}{\__erw_counter_use:n{#1}}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-doc-cmd
#+begin_src latex
  \ProvideDocumentCommand{\CounterLabel}{mm}
  % <name>
  % <label>
  {%
    \__erw_counter_write:nn { #1 }{ #2 }
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-doc-cmd
#+begin_src latex
  \ProvideDocumentCommand{\CounterRef}{mm}
  {
    \__erw_counter_ref:nn { #1 }{ #2 }
  }
#+end_src

**** tangle
:PROPERTIES:
:header-args: :tangle "../tex/erw-counter.sty"
:END:

#+header: :noweb yes
#+begin_src latex
  <<tex-license>>
#+end_src

#+begin_src latex
  \ProvidesPackage{erw-boilerplate}{2025/12/21}{1.0}
  { <<org-counter-summary> }
#+end_src

#+header: :noweb yes
#+begin_src latex  
  <<tex-counter-info>>
#+end_src

#+begin_src latex
  \ExplSyntaxOn
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- guard ---------
  <<tex-counter-guard>>
#+end_src

#+header: :noweb yes
#+begin_src latex
    % --- reference ---
    <<tex-counter-expl3>>
#+end_src

#+header: :noweb yes
#+begin_src latex
    % --- reference ---
    <<tex-counter-doc-cmd>>
#+end_src

#+begin_src latex
  \ExplSyntaxOff
#+end_src

*** example
:PROPERTIES:
:header-args: :tangle "../tex/example-counter.tex"
:END:

#+begin_src latex
  \documentclass{article}  
#+end_src

#+begin_src latex
  \usepackage{lipsum,tcolorbox,graphicx}
  \tcbuselibrary{listings,raster,skins}
  \newtcblisting{listing-tex}{
    listing and text,
    listing options={language=Tex, style=tcblatex}
  }
#+end_src

#+begin_src latex
  \ExplSyntaxOn
  \file_input:n{../tex/erw-counter.sty}
  \ExplSyntaxOff
#+end_src

#+begin_src latex
  \CounterSetup{ new = foo }
#+end_src

#+begin_src latex
  \begin{document}
#+end_src

#+begin_src latex
  \begin{listing-tex}
    % \ExplSyntaxOn
    % \file_input:n{../tex/erw-counter.sty}
    % \ExplSyntaxOff
    % \CounterSetup{ new = foo }

    % Expected: 0
    Initial value: \CounterUse{foo}

    % Expected: 5
    Final value: \CounterRef{foo}{final}

    \CounterIncrement{foo}
    \CounterIncrement{foo}
    \CounterIncrement{foo}

    % Expected: 3
    Value after 3 increments: \CounterUse{foo}

    \CounterIncrement{foo}
    \CounterIncrement{foo}
    \CounterLabel{foo}{final}
  \end{listing-tex}
#+end_src

#+begin_src latex
  \end{document}
#+end_src

** boilerplate
*** source
**** section
***** info

#+name: org-boilerplate-summary
#+begin_src latex
  Standalone expl3-like commands for use in implementations
#+end_src

***** int

#+header: :noweb-ref tex-boilerplate
#+begin_src latex
  \cs_new:Npn
  \__erw_int_finish:nn
  #1 % start
  #2 % count
  { \int_eval:n{#1+#2-1} }
#+end_src

***** plh

~plh~ means placeholder

#+header: :noweb-ref tex-boilerplate
#+begin_src latex
  \cs_new:Npn
  \__erw_braced_plh:n
  #1
  { \exp_not:n{ {## #1} } }
  \cs_new:Npn
  \__erw_braced_plh:nn
  #1 % <start>
  #2 % <finish>
  { \int_step_function:nnN {#1}{#2}\__erw_braced_plh:n }
  \cs_generate_variant:Nn\__erw_braced_plh:nn{ne}
#+end_src

***** inline

#+header: :noweb-ref tex-boilerplate
#+begin_src latex
  % boilerplate
  \cs_new_protected:Npn
  \__erw_inline:nn
  #1 % <arg spec>
  #2 % <code>
  {
    \cs_gset:cn{__erw_lambda:#1}{#2}
    \use:c{__erw_lambda:#1}
  }
  % Example:
  % \__erw_inline:nn{n}{Hello~#1!}{world}
#+end_src

***** refactor

#+header: :noweb-ref tex-boilerplate
#+begin_src latex
  \cs_new_protected:Npn
  \__erw_adapt_cmd_wrapper_to_N:N #1
  {
    \group_begin:
    
    \exp_args:NNe
    \tl_set:Nn \l_tmpa_tl
    { \cs_split_function:N #1 }
    
    \exp_args:NNe
    \str_set:Nn \l__erw_base_str
    { \exp_last_unbraced:Ne
      \use_i:nnn {\l_tmpa_tl}  }

    \exp_args:NNe
    \str_set:Nn \l__erw_sig_str
    { \exp_last_unbraced:Ne
      \use_ii:nnn{\l_tmpa_tl} }

    \exp_args:NNe
    \str_set:Nn \l__erw_sig_tail_str
    { \exp_args:Ne
      \tl_range:nnn {\l__erw_sig_str} {3} {-1} }

    \exp_args:NNe
    \int_set:Nn \l_tmpa_int% \l__erw_sig_tail_int
    { \str_count:N \l__erw_sig_tail_str }

    % \int_show:N%\l__erw_sig_tail_int
    % \l_tmpa_int % pass

    \__erw_adapt_cmd_wrapper_to_N:eeee
    { \str_use:N\l__erw_base_str }
    { \str_use:N\l__erw_sig_str }
    { \str_use:N\l__erw_sig_tail_str }
    { \__erw_braced_plh:ne
      { 2 }{ \exp_args:Ne
        \__erw_int_finish:nn{ 2 }{ \l_tmpa_int } } }

    \group_end:
    
  }
#+end_src

#+header: :noweb-ref tex-boilerplate
#+begin_src latex
  \cs_new_protected:Npn
  \__erw_adapt_cmd_wrapper_to_N:nnnn
  #1
  #2
  #3
  #4
  {
    \cs_new_protected:cn
    { #1 :N #3 }
    {
      \group_begin:
      
      \exp_args:NNe
      \tl_set:Nn \l_tmpa_tl
      { \cs_split_function:N ##1 }

      \exp_args:NNe
      \str_set:Nn \l__erw_base_str
      { \exp_last_unbraced:Ne
        \use_i:nnn {\l_tmpa_tl}  }

      \exp_args:NNe
      \str_set:Nn \l__erw_sig_str
      { \exp_last_unbraced:Ne
        \use_ii:nnn{\l_tmpa_tl} }
      
      \exp_last_unbraced:Ne
      \use:c { { #1 : #2 }
        { \l__erw_base_str }
        { \l__erw_sig_str }
      }
      #4

      \group_end:
      
    }
  }
  \cs_generate_variant:Nn\__erw_adapt_cmd_wrapper_to_N:nnnn{eeee}
#+end_src

***** clist

#+begin_src latex
  \cs_new_protected:Npn
  \__erw_clist_sort_in_place:N
  #1 % <clist>
  {
    \clist_sort:Nn#1
    {
      \str_compare:nNnTF { ##1 } < { ##2 }
      { \sort_return_same: }
      { \sort_return_swapped: }
    }
  }
#+end_src

#+begin_src latex
  \prg_new_protected_conditional:Npnn
  \__erw_clist_if_subset:NN #1#2 { TF }
  {
    \clist_map_inline:Nn #1
    {
      \clist_if_in:NnF #2 { ##1 }
      { \prg_return_false: }
    }
    \prg_return_true:
  }
#+end_src

***** scope-infix-type

#+begin_src latex
  \cs_new_protected:Npn
  \__erw_scope_infix_type:nNN
  #1 % <input>
  #2 % <output>
  #3 % <regex>
  {
    \seq_set_regex_extract_once:NNn
    #2
    #3
    { #1 }
  }
#+end_src

#+begin_src latex
  \cs_new_protected:Npn
  \__erw_scope_infix_type:NNN
  #1 % <input>
  #2 % <output>
  #3 % <regex>
  {
    \exp_args:Ne
    \__erw_scope_infix_type:nNN
    { \cs_to_str:N #1 }
    #2#3
    % Example:
    % \tl_set:N\l_tmpa_tl{ \l__foo_str }
    % \__erw_scope_infix_type:NN
    % \l_tmpa_tl
    % \l_tmpa_seq
    % \exp_args:Ne\tl_show:n{
    % Scope: \seq_item:Nn\l_tmpa_seq{ 2 } % l
    % Infix: \seq_item:Nn\l_tmpa_seq{ 3 } % foo
    % Type: \seq_item:Nn\l_tmpa_seq{ 4 } % str
    % }
  }
#+end_src

**** tangle
:PROPERTIES:
:header-args: :tangle ../tex/erw-boilerplate.sty
:END:

#+header: :noweb yes
#+begin_src latex
  <<tex-license>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  \ProvidesExplPackage{erw-boilerplate}{2025/12/21}{1.0}
  { <<org-boilerplate-summary>> }
#+end_src

#+begin_src latex
  % \ExplSyntaxOn
#+end_src

#+header: :noweb yes
#+begin_src latex
  <<tex-boilerplate>>
#+end_src

#+begin_src latex
  % \ExplSyntaxOff
#+end_src

*** example
**** adapt-cmd-wrapper-to-N
:PROPERTIES:
:header-args: :tangle ../tex/example-adapt-cmd-wrapper-to-N.tex
:END:

#+begin_src latex
  % Terminal:
  % cd pdf
  % export TEXMFOUTPUT=$(realpath ../tex)
  % source_file='../tex/example-<module>.tex'
  % pdflatex -shell-escape "\\def\\texdir{$TEXMFOUTPUT}\input " "$source_file"
#+end_src

#+header: :noweb yes
#+begin_src latex
  <<tex-snippetpath>>
  %\def\snippetpath{\texdir/\jobname-snippet}
#+end_src

#+begin_src latex
 \begin{filecontents}[overwrite]{\snippetpath.tex}
   \documentclass{article}
   \usepackage{../tex/erw-boilerplate}
   
   \ExplSyntaxOn
   \cs_new:Nn\__erw_bar:n{ Hello~#1! }
   
   \cs_new_protected:Nn
   \__erw_foo:nnn{ \use:c{#1:#2}{#3} }
   
   \__erw_adapt_cmd_wrapper_to_N:N
   \__erw_foo:nnn
   \ExplSyntaxOff
   
   \begin{document}
   \ExplSyntaxOn
   \__erw_foo:Nn
   \__erw_bar:n{world}
   \ExplSyntaxOff
   \end{document}
 \end{filecontents}
#+end_src

#+begin_src latex
  \documentclass{article}
  \usepackage{lipsum,tcolorbox,graphicx}
  \tcbuselibrary{listings,raster,skins}
  \newtcblisting{listing-tex}{
    listing and text,
    listing options={language=Tex, style=tcblatex}
  }
#+end_src

#+begin_src latex
  \begin{document}
  \tcbinputlisting{
    lower separated=false,
    listing and comment,
    listing file={\snippetpath},
    listing options={style=tcblatex},
    pdf comment = {../pdf/\jobname-snippet.pdf},
    comment style={
      raster columns=1,
      graphics options={trim=1.18in 9.06in 1.18in 1.18in, clip, width=\linewidth},
      % https://ctan.math.washington.edu/tex-archive/macros/latex/contrib/tcolorbox/tcolorbox.pdf#section*.656
    },
    freeze pdf=false,
    run system command={pdflatex -interaction=nonstopmode \snippetpath.tex}
  }
  \end{document}
#+end_src

**** inline
:PROPERTIES:
:header-args: :tangle ../tex/example-inline.tex
:END:

#+begin_src latex
  \documentclass{article}
  \usepackage{tcolorbox}
  \usepackage{../tex/erw-boilerplate}
  \tcbuselibrary{listings}
  \newtcblisting{listing-tex}{
    listing and text,
    listing options={language=Tex, style=tcblatex}
  }
#+end_src

#+begin_src latex
  \ExplSyntaxOn
  \exp_args:NNx
  \cs_new_protected:Nn\__erw_test:nn
  {
    \exp_not:n
    {
      \__erw_inline:nn{n}
      {
        (##1)
      }
    }\__erw_braced_plh:nn{2}{2}
  }
  \ExplSyntaxOff
#+end_src

#+begin_src latex
  \begin{document}
  \begin{listing-tex}
    % \documentclass{article}
    % \usepackage{../tex/erw-boilerplate}
    % \ExplSyntaxOn
    % \exp_args:NNe
    % \cs_new_protected:Nn\__erw_test:nn
    % { \exp_not:n
    %   {\__erw_inline:nn{n}{ (##1) } }
    %   \__erw_braced_plh:nn{2}{2} }
    % \ExplSyntaxOff
    % \begin{document}
    \ExplSyntaxOn
    \__erw_inline:nn{n}{Hello~#1!}{world}\par
    \__erw_test:nn{foo}{bar}
    \ExplSyntaxOff
    % \end{document}
  \end{listing-tex}
  \end{document}
#+end_src

** biblatex
*** source
**** section
***** info

#+name: org-biblatex-summary
#+begin_src org
  In text citation template exposing a keyval interface
#+end_src

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % -----------------------------------------------------------------
#+end_src

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % Usage:
#+end_src

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % ```
  % \DeclareInstance{erw-biblatex}{<instance>}{standard}
  %   { cite = { <code> } }
  % ```
  % where `<code>` is in terms of `#1`, `#2`, and `#3`,
  % representing prenote, postnote, and key.
#+end_src

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % ```
  % \BiblatexCite[<instance>]
  % { key = <key>, prenote = <prenote>, postnote = <postnote> }
  % ```
#+end_src

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % Limitation:
  % - Does not handle multicite
#+end_src

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % Also see:
  % - https://mirrors.ibiblio.org/CTAN/macros/latex/contrib/biblatex/doc/biblatex.pdf#subsection.3.9
#+end_src

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % Versioning:
  % 2025-12-21 1.1 Guard using \ProvidesPackage
#+end_src

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % -----------------------------------------------------------------
#+end_src

***** biblatex

#+header: :noweb-ref tex-biblatex-biblatex
#+begin_src latex
  \DeclareCiteCommand{ \__erw_citeauthorfull }
  {}
  { \printnames[given-family][1-1]{author} }
  {}
  {}
#+end_src

***** expl3

#+header: :noweb-ref tex-biblatex-expl3
#+begin_src latex
  \makeatletter
  % should this be a const?
  \tl_const:Nx \c__erw_biblatex_bbxfile_tl { \blx@bbxfile }
  \makeatother
#+end_src

#+header: :noweb-ref tex-biblatex-expl3
#+begin_src latex
  \msg_new:nnn{ __erw_biblatex }{ generic }{ #1 }
#+end_src

#+header: :noweb tex-biblatex-expl3
#+begin_src latex
  % Warning no longer needed
  % \msg_warning:nnn{__erw_biblatex}{generic}
  % {Add~to~your~preamble~inside~expl3~syntax~mode:
  %   \makeatletter
  %   \tl_const:Nx \c__erw_biblatex_bbxfile_tl { \blx@bbxfile }
  %   \makeatother
  % }  
#+end_src

#+header: :tangle no
#+begin_src latex
  % \AtBeginDocument{%
  % \typeout{blx@cbxfile: \meaning\blx@cbxfile}
  % \typeout{blx@bbxfile: \meaning\blx@bbxfile}
  % }
#+end_src

#+header: :noweb-ref tex-biblatex-expl3
#+begin_src latex
  \prg_new_conditional:Npnn \__erw_biblatex_numeric: { TF }
  {
    \bool_lazy_or:nnTF
    { \str_if_eq_p:Vn \c__erw_biblatex_bbxfile_tl { numeric } }
    { \str_if_eq_p:Vn \c__erw_biblatex_bbxfile_tl { numeric-comp } }
    { \prg_return_true: }
    { \prg_return_false: }
  }
#+end_src

#+header: :noweb-ref tex-biblatex-expl3
#+begin_src latex
  \prop_new:N\g__erw_biblatex_prop
  \keys_define:nn{__erw_biblatex}
  {
    key.prop_gput:N = \g__erw_biblatex_prop,
    key.default:n = {\c_novalue_tl},
    prenote.prop_gput:N = \g__erw_biblatex_prop,
    prenote.default:n = {\c_empty_tl},
    postnote.prop_gput:N = \g__erw_biblatex_prop,
    postnote.default:n = {\c_empty_tl},
  }
#+end_src

#+header: :noweb tex-biblatex-expl3
#+begin_src latex
  \keys_set:nn{__erw_biblatex}{ key, prenote, postnote }
#+end_src

***** template

#+header: :noweb-ref tex-biblatex-template
#+begin_src latex
  \DeclareObjectType{erw-biblatex}{1}
  \DeclareTemplateInterface{erw-biblatex}
  { standard }{1}
  {
    cite : function{3},
  }
#+end_src

#+header: :noweb-ref tex-biblatex-template
#+begin_src latex
  \cs_new:Nn
  \__erw_biblatex_helper:nnnN
  {#4{#1}{#2}{#3}}
  \cs_generate_variant:Nn\__erw_biblatex_helper:nnnN{eee,ffe}
#+end_src

#+header: :noweb-ref tex-biblatex-template
#+begin_src latex
  \DeclareTemplateCode{erw-biblatex}
  { standard }
  {1}
  {
    cite = \__erw_biblatex_cite:nnn,
  }
  {%
    \AssignTemplateKeys
    
    \keys_set:nn{__erw_biblatex}{#1}

    \group_begin:

    \exp_args:NNe
    \tl_set:Nn\l_tmpa_tl
    { \prop_item:Nn\g__erw_biblatex_prop{key} }

    \exp_args:Ne
    \tl_if_novalue:nTF{\l_tmpa_tl}
    {%
      \msg_warning:nnn{__erw_biblatex}{generic}{bibliography~key~not~set}
    }
    {%
      \__erw_biblatex_helper:ffeN
      { \prop_item:Nn\g__erw_biblatex_prop{ prenote } }
      { \prop_item:Nn\g__erw_biblatex_prop{ postnote } }
      { \l_tmpa_tl }
      \__erw_biblatex_cite:nnn
    }
    
    \group_end:

    \keys_set:nn{__erw_biblatex}{ key, prenote, postnote }
    
  }
#+end_src

***** instance

#+header: :noweb-ref tex-biblatex-instance
#+begin_src latex
  \DeclareInstance{erw-biblatex}{default}{standard}
  {
    cite = { \cite[#1][#2]{#3} }
  }
#+end_src

#+header: :noweb-ref tex-biblatex-instance
#+begin_src latex
  \DeclareInstance{erw-biblatex}{author-num}{standard}
  {
    cite = { \__erw_citeauthorfull{#3}\cite[#1][#2]{#3} }
  }
#+end_src

#+header: :noweb-ref tex-biblatex-instance
#+begin_src latex
  \DeclareInstance{erw-biblatex}{title-num}{standard}
  {
    cite = { \citetitle{#3}\cite[#1][#2]{#3} }
  }
#+end_src

***** document

#+header: :noweb-ref tex-biblatex-doc-cmd
#+begin_src latex
  \ProvideDocumentCommand{\BiblatexCite}{O{default}m}
  {%
    \tl_if_regex_match:nnTF { #1 }{ -num$ }
    {%
      \__erw_biblatex_numeric:TF
      {}
      {%
        \exp_last_unbraced:Ne
        \msg_warning:nnnn{{__erw_biblatex}{generic}
          { \tl_to_str:N\c__erw_biblatex_bbxfile_tl~\c__erw_biblatex_bbxfile_tl~inconsistent~with~template~`#1`}
          {Use~ \tl_to_str:N\c__erw_biblatex_bbxfile_tl~`numeric`~or~`numeric-comp`}}
      }
    }{}
    % 
    \UseInstance{erw-biblatex}{#1}{#2}
  }
#+end_src

**** tangle
:PROPERTIES:
:header-args: :tangle ../tex/erw-biblatex.sty
:END:

#+header: :noweb yes
#+begin_src latex
  <<tex-license>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  \ProvidesExplPackage{erw-biblatex}{2025/12/22}{1.1}
  { <<org-biblatex-summary>> }
#+end_src

#+header: :noweb yes
#+begin_src latex
  <<tex-biblatex-info>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- expl3
  <<tex-biblatex-expl3>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- biblatex
  <<tex-biblatex-biblatex>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- template
  <<tex-biblatex-template>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- instance
  <<tex-biblatex-instance>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- document command
  <<tex-biblatex-doc-cmd>>
#+end_src

*** example
:PROPERTIES:
:header-args: :tangle ../tex/example-biblatex.tex
:END:

#+begin_src latex
    \documentclass{article}
    % \usepackage[style=authoryear]{biblatex}
    \usepackage[style=numeric-comp]{biblatex}
    \addbibresource{../tex/sample-1.bib}
#+end_src
    
#+begin_src latex
    \usepackage{lipsum,xtemplate,tcolorbox}
    \tcbuselibrary{listings}
    \newtcblisting{listing-tex}
    { listing options = { language = Tex, style = tcblatex } }
#+end_src
    
#+begin_src latex
  \usepackage{../tex/erw-biblatex}
  %  \ExplSyntaxOn
  %  \file_input:n{../tex/erw-biblatex.sty}
  %  \ExplSyntaxOff
#+end_src
    
#+begin_src latex
  \begin{document}
#+end_src
    
#+begin_src latex
  \begin{listing-tex}
    %\usepackage[style=numeric-comp]{biblatex}
    %\addbibresource{../tex/sample.bib}
    % \input{../tex/erw-biblatex.sty}
    \section{Fancy quotes}

    \noindent\lipsum[1][1]\\
    ---~\BiblatexCite[author-num]{ key = aristotle:anima }

    \vspace{1em}

    \noindent\lipsum[1][2]\\
    ---~\BiblatexCite[title-num]{ key = aristotle:anima, postnote = {413a3-10} }

    \section{References}
    \printbibliography[heading=none]

  \end{listing-tex}
#+end_src
    
#+begin_src latex
  \end{document}
#+end_src

** socket

#+begin_src latex
% Also see:
% - https://tex.stackexchange.com/q/755612/112708
#+end_src

*** source
**** section
***** info

#+name: org-socket-summary
#+begin_src org
  Keyval wrapper around LaTeX's socket management.
#+end_src

#+header: :noweb-ref tex-socket-info
#+begin_src latex
  % Example:
  % \keys_set:nn{erw-socket}
  % {
  %   socket / new =
  %   {
  %     name = {greeting},
  %     arity = {0},
  %     plugs = {
  %       formal = {Dear Sir/Madam,},
  %       informal = {Hi there,},
  %       friendly = {Hello, friend!}
  %     },
  %     assign-plug = {
  %       method = {identity:n},
  %       args = {formal}
  %     }
  %   }
  % }
#+end_src

***** global
****** usepackage

#+header: :noweb-ref tex-socket-expl3
#+begin_src latex
  \usepackage{../tex/erw-boilerplate}
#+end_src

****** msg

#+header: :noweb-ref tex-socket-expl3
#+begin_src latex
  % msg
  \msg_new:nnn{erw-socket}{generic}{❌ #1}
  \msg_new:nnn{erw-socket}{missing}{❌ missing~value~for~key~#1}
#+end_src

****** cs-new

#+header: :noweb-ref tex-socket-expl3
#+begin_src latex  
  \keys_define:nn{erw-socket}
  {
    global / cs-new.code:n = {
      \cs_gset_eq:NN
      \__erw_socket_new:nn#1
    },
    global / cs-new.default:n = { \socket_new:nn },
  }
  \keys_set:nn{erw-socket}{ global / cs-new }
#+end_src

#+header: :noweb-ref tex-socket-expl3
#+begin_src latex  
  \keys_define:nn{erw-socket}
  {
    global / cs-new-plug.code:n = {
      \cs_gset_eq:NN
      \__erw_socket_new_plug:nnn#1
    },
    global / cs-new-plug.default:n = {
      \socket_new_plug:nnn
      % alternatively:
      % \socket_new_set:nnn
    }
  }
  \keys_set:nn{erw-socket}{ global / cs-new-plug }
#+end_src

#+header: :noweb-ref tex-socket-expl3
#+begin_src latex  
  % socket-specific
  \keys_define:nn{erw-socket}
  {
    global / cs-assign-plug.code:n = {
      \cs_gset_eq:NN
      \__erw_socket_assign_plug:nn#1
    },
    global / cs-assign-plug.default:n = {
      \socket_assign_plug:nnn
    }
  }
  \keys_set:nn{erw-socket}{ global / cs-assign-plug }
#+end_src

****** assign-plug
******* code

#+header: :noweb-ref tex-socket-expl3
#+begin_src latex
  \cs_new_protected:Npn
  \__erw_socket_define_assign_plug:nnn
  #1 % <cs name>
  #2 % <signature>
  #3 % <code>
  {
    \keys_define:nn{erw-socket}
    {
      internal / assign-plug / #1:#2 .code:n =
      % ##1 <socket name>
      % ##2 <arguments>
      {
        \__erw_inline:nn
        {n#2}
        {
          \__erw_inline:nn
          {#2}
          {
            \__erw_socket_assign_plug:nn
            {##1}
            {#3}
          }\__erw_braced_plh:ne{2}
          {%
            \exp_args:Nne
            \__erw_int_finish:nn{2}
            {\str_count:n{#2}}}
        }
      }
      % Call: \__erw_socket_define_assign_plug:nnn{identity}{n}{#1}
      % Side effect: \keys_define:nn{erw-socket}
      % { internal/assign-plug/identity:n.code:n = \erw_socket_assign_plug:nn{##1}{##1} }
      % Wanted instead: \erw_socket_assign_plug:nn{##1}{##2}    
    }
  }
#+end_src

#+header: :noweb-ref tex-socket-expl3
#+begin_src latex
  \prop_new:N\g__erw_socket_define_prop
  \prop_new:N\g__erw_socket_set_prop
  \keys_define:nn{erw-socket}
  {
    define / assign-plug.code:n =
    % Example:
    % - code:
    % \keys_set:nn{erw-socket}
    % {
    % define / assign-plug =
    % {
    % method = { identity:n },
    % code = { #1 }
    % }
    % }
    %   \keys_set:nn{erw-socket}
    %   {
    %   bind / assign-plug =
    %   {
    %   socket-name = {greeting},
    %   method = { identity:n },
    %   args = { friendly }
    % }
    % }
    %   \keys_set:nn{erw-socket}
    %   {
    %   eval / assign-plug  =
    %   {
    %   socket-name = { greeting },
    % }
    % }
    %   - side effect:
    %   \__erw_socket_assign_plug:nn{ greeting }{ friendly }
    {
      \prop_gput_from_keyval:Nn
      \g__erw_socket_define_prop
      {
        cs-name = \c_novalue_tl,
        code = \c_novalue_tl,
        #1
      }
      \prop_map_inline:Nn
      \g__erw_socket_define_prop
      {
        \str_case:nnTF{##1}
        {
          {cs-name}{}
          {code}{}
        }
        {
          \tl_if_novalue:nT{ ##2 }
          { { \msg_error:nnn{ __erw_socket }
              { generic }{ key~#1~novalue } } }
        }{}
      }

      \__erw_socket_define_assign_plug_method:ee
      {
        \prop_item:Nn
        \g__erw_socket_define_prop{ cs-name }
      }
      {
        \prop_item:Nn
        \g__erw_socket_define_prop{ argspec }
      }
    }
  }
#+end_src

***** socket
****** plugs
******* prop

#+header: :noweb-ref tex-socket-expl3
#+begin_src latex
  \seq_new:c{ g__erw_socket_#1_plugs_seq }
#+end_src

******* put

#+header: :noweb-ref tex-socket-expl3
#+begin_src latex
  \cs_new_protected:Npn
  \__erw_socket_plugs_put:nn
  #1 % <socket name>
  #2 % <plug name>
  {%
    \seq_if_in:cnTF{g__erw_socket_#1_plugs_seq}
    { #2 }
    { \c_empty_tl }
    { \seq_put_right:cn{ g__erw_socket_#1_plugs_seq{ ##1 } } }
    % Example:
    % \__erw_socket_plugs_put:n
    % { greeting }
    % { formal }
  }
#+end_src
  
****** keys

#+begin_src latex
  % Global bc "We only support declarations on top-level"
  % https://tug.ctan.org/macros/latex-dev/base/ltsockets-code.pdf#HD.16
  \prop_new:N\g__erw_socket_prop
  \tl_new:N\g__erw_socket_arity_tl
  \tl_new:N\g__erw_socket_name_tl
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-socket-expl3-socket-new
#+begin_src latex
  \prop_get:NnNTF
  \g__erw_socket_prop
  { arity }
  \g__erw_socket_arity_tl
  {
    \exp_last_unbraced:Ne
    \__erw_socket_new:nn
    { { \g__erw_socket_name_tl }{ \g__erw_socket_arity_tl } }
    \seq_new:c{ g__erw_socket_ \g__erw_socket_name_tl _plugs_seq }
  }
  { \msg_warning:nnn{ __erw_socket }{ missing }{ arity } }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-socket-expl3-socket-plugs
#+begin_src latex
  \prop_get:NnNTF
  \g__erw_socket_prop{ plugs }
  \l__erw_plugs_clist
  {
    \seq_if_exist:cTF{ g__erw_socket_ \g__erw_socket_name_tl _plugs_seq }
    {
      \keyval_parse:nnV
      {
        \msg_warning:nnn
        { __erw_socket }
        { missing }
      }
      {
        \__erw_inline:nn{ nn }
        {
          \exp_args:Ne
          \__erw_socket_new_plug:nnn
          { \g__erw_socket_name_tl }{ ##1 }{ ##2 }
          \seq_gput_right:cn{
            g__erw_socket_ \g__erw_socket_name_tl _plugs_seq
          }{ ##1 }
        }
      }\l__erw_plugs_clist
    }
    {
      \msg_warning:nnn
      { __erw_socket }
      { generic }
      { unable~to~process~plugs }
    }    
  }
  { \msg_warning:nnn{ __erw_socket }{ missing }{ plugs } }
#+end_src

#+header: :noweb yes
#+header: :noweb-ref tex-socket-expl3
#+begin_src latex
  \keys_define:nn{ __erw_socket }
  {
    socket / new.code:n =
    {

      \prop_clear:N
      \g__erw_socket_prop

      \prop_set_from_keyval:Nn
      \g__erw_socket_prop{ #1 }

      \prop_get:NnNTF
      \g__erw_socket_prop
      { name }
      \g__erw_socket_name_tl
      {
        <<tex-socket-expl3-socket-new>>

        \group_begin:

        <<tex-socket-expl3-socket-plugs>>

        \group_end:
      }
      { \msg_warning:nnn{ __erw_socket }{ missing }{ name } }

    }
  }
 #+end_src

**** tangle
:PROPERTIES:
:header-args: :tangle ../tex/erw-socket.sty
:END:

#+header: :noweb yes
#+begin_src latex
  <<tex-license>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  \ProvidesExplPackage{erw-socket}{2025/12/22}{1.1}
  { <<org-socket-summary>> }
#+end_src

#+header: :noweb yes
#+begin_src latex
  <<tex-socket-info>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- expl3
  <<tex-socket-expl3>>
#+end_src

*** example
:PROPERTIES:
:header-args: :tangle ../tex/example-socket.tex
:END:

#+begin_src latex
  \documentclass{article}
#+end_src

#+begin_src latex
  \usepackage{../tex/erw-socket}
#+end_src

#+begin_src latex
  \ExplSyntaxOn
  \keys_set:nn{erw-socket}
  {
    socket / new = {
      name = {greeting},
      arity = {0},
      plugs = {
        formal = {Dear~Sir/Madam,},
        informal = {Hi~there,},
        friendly = {Hello,~friend!}
      },
    }
  }

  \AssignSocketPlug{greeting}{formal}

  \ExplSyntaxOff
#+end_src

#+begin_src latex
  \begin{document}
  \UseSocket{greeting}{formal}{}
  \end{document}
#+end_src

* shell
** compile
:PROPERTIES:
:ID:       e9680a4a-1f36-40b5-8d74-d846ce80b618
:END:

#+name: shell-example
#+begin_src shell
  # https://tex.stackexchange.com/a/756108/112708
  export TEXMFOUTPUT=$(realpath $(pwd)/../tex)
  module_name="foo"
  [[ $(basename $(pwd)) == "${module_name}" ]] || { cd pdf; }
  pdflatex "\\def\\texdir{$TEXMFOUTPUT}\input"  ../tex/example-"${module_name}".tex
#+end_src

** import

#+begin_src shell
  # don't indent
  url='https://'\
  'raw.githubusercontent.com/plk/biblatex/'\
  '8e5b0605f017b64af04463447e10f02c933dee89/'\
  'bibtex/bib/biblatex/'\
  'biblatex-examples.bib'
  keys_ar=('aristotle:anima')
  #    keys_ar=('aristotle:anima' 'kant:krv')
  pattern=$(IFS="|"; echo "${keys_ar[*]}")
  curl "$url" | sed -En "/^@.*\{(${pattern}),/,/^}/p" > ../tex/sample-1.bib
#+end_src

#+RESULTS:

#+begin_src shell
  curl -L -o ../tex/sample-1.bib \
https://raw.githubusercontent.com/plk/biblatex/8e5b0605f017b64af04463447e10f02c933dee89/bibtex/bib/biblatex/biblatex-examples.bib
#+end_src
