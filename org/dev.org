#+title: helpers.tex --- dev.org

Meta file to generate files.

* tex
** license

#+name: tex-license
#+begin_src latex
% -----------------------------------------------------------------
% Copyright (C) 2025 by Erwann Rogard
% - Source repository: https://github.com/rogard/helpers.tex
% - Released under the LaTeX Project Public License v1.3c or later
% - See http://www.latex-project.org/lppl.txt
% -----------------------------------------------------------------
#+end_src

** counter
*** source
**** section
***** info

#+header: :noweb-ref tex-counter-info
#+begin_src latex
  % Info:
  % - Counter commands allowing cross-referencing
#+end_src

#+header: :noweb-ref tex-counter-info
#+begin_src latex
  % - Commands:
  % `\CounterSetup{ new = <name> }`
  % `\CounterIncrement{<name>}`
  % `\CounterUse{<name>}`
  % `\CounterLabel{<name>}{<label>}`
  % `\CounterRef{<name>}{<label>}`
#+end_src

#+header: :noweb-ref tex-counter-info
#+begin_src latex
  % - Compilation:
  % -- Two passes required
  % -- To start anew, delete auxiliary files
#+end_src

***** guard

#+header: :noweb-ref tex-counter-guard
#+begin_src latex
  \tl_if_exist:NTF \g__erw_counter_flag_tl
  {%
    \msg_warning:nnn { __erw_counter }{ generic }{ already-loaded }
    \file_input_stop:
  }
  {%
    \tl_gset:Nn \g__erw_counter_flag_tl{}
  }
#+end_src

***** expl3

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \msg_new:nnn{__erw_counter}{generic}{#1}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new:Npn \__erw_counter_name:n
  #1 % string - <name>
  {g__erw_counter_#1_int}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \keys_define:nn{__erw_counter}
  {%
    new.code:n = { \int_gzero_new:c{\__erw_counter_name:n{#1}} }
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new_protected:Npn \__erw_counter_increment:n
  #1 % <string: name>
  {%
    \int_incr:c{\__erw_counter_name:n{#1}}
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new:Npn \__erw_counter_use:n
  #1 % <string: name>
  {%
    \int_use:c{\__erw_counter_name:n{#1}}
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \iow_new:N \g__erw_counter_aux_iow
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \str_const:Ne\c__erw_counter_aux_str
  {\c_sys_jobname_str .erw.counter.aux}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \AtBeginDocument
  {
    \file_if_exist:nTF { \c__erw_counter_aux_str }
    {
      \file_input:n { \c__erw_counter_aux_str }
    }
    {
      \exp_args:NNe
      \iow_open:Nn \g__erw_counter_aux_iow { \c__erw_counter_aux_str }
    }
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \AtEndDocument
  {
    \iow_close:N \g__erw_counter_aux_iow
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new_protected:Npn \__erw_counter_write:nnn
  #1 % <value>
  #2 % <name>
  #3 % <label>
  {
    \iow_now:Nx \g__erw_counter_aux_iow
    {
      \token_to_str:N \ExplSyntaxOn
      \token_to_str:N \__erw_counter_set:nnn { #2 }{ #3 }{ #1 }
      \token_to_str:N \ExplSyntaxOff
    }
  }
  \cs_generate_variant:Nn \__erw_counter_write:nnn{e}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new_protected:Npn \__erw_counter_write:nn
  #1 % <name>
  #2 % <label>
  {%
    \__erw_counter_write:enn{ \__erw_counter_use:n{ #1 } }
    { #1 }
    { #2 }
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new:Npn\__erw_counter_label:nn
  #1 % <name>
  #2 % <label>
  {g__erw_counter_label_#1_#2_tl}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new_protected:Npn \__erw_counter_set:nnn
  #1 % infix
  #2 % label
  #3 % value
  {%
    \exp_args:Ne
    \tl_gset:cn { \__erw_counter_label:nn{ #1 }{ #2 } } { #3 }
  }
  \cs_generate_variant:Nn\__erw_counter_set:nnn{e}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-expl3
#+begin_src latex
  \cs_new:Npn \__erw_counter_ref:nn
  #1 % infix
  #2 % label
  {%
    \tl_if_exist:cTF { \__erw_counter_label:nn{ #1 }{ #2 } }
    {%
      \tl_use:c { \__erw_counter_label:nn{ #1 }{ #2 } }
      \msg_note:nnn { __erw_counter } { generic }
      { To~reset~counter~references,~delete~\c__erw_counter_aux_str. }
    }
    { \msg_warning:nnn{__erw_counter}{generic}{Compile~one~more~time} }
  }
#+end_src

***** doc-cmd

#+header: :tangle no
#+header: :noweb-ref tex-counter-doc-cmd
#+begin_src latex
  \ProvideDocumentCommand{\CounterSetup}{m}
  { \keys_set:nn{__erw_counter}{#1} }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-doc-cmd
 #+begin_src latex
  \ProvideDocumentCommand{\CounterIncrement}{m}{\__erw_counter_increment:n{#1}}
  \ProvideDocumentCommand{\CounterUse}{m}{\__erw_counter_use:n{#1}}
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-doc-cmd
#+begin_src latex
  \ProvideDocumentCommand{\CounterLabel}{mm}
  % <name>
  % <label>
  {%
    \__erw_counter_write:nn { #1 }{ #2 }
  }
#+end_src

#+header: :tangle no
#+header: :noweb-ref tex-counter-doc-cmd
#+begin_src latex
  \ProvideDocumentCommand{\CounterRef}{mm}
  {
    \__erw_counter_ref:nn { #1 }{ #2 }
  }
#+end_src

**** tangle
:PROPERTIES:
:header-args: :tangle "../tex/erw-counter.sty"
:END:

#+header: :noweb yes
#+begin_src latex
  <<tex-license>>
#+end_src

#+header: :noweb yes
#+begin_src latex  
  <<tex-counter-info>>
#+end_src

#+begin_src latex
  \ExplSyntaxOn
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- guard ---------
  <<tex-counter-guard>>
#+end_src

#+header: :noweb yes
#+begin_src latex
    % --- reference ---
    <<tex-counter-expl3>>
#+end_src

#+header: :noweb yes
#+begin_src latex
    % --- reference ---
    <<tex-counter-doc-cmd>>
#+end_src

#+begin_src latex
  \ExplSyntaxOff
#+end_src

*** example
:PROPERTIES:
:header-args: :tangle "../tex/example-counter.tex"
:END:

#+begin_src latex
  \documentclass{article}  
#+end_src

#+begin_src latex
  \usepackage{lipsum,tcolorbox,graphicx}
  \tcbuselibrary{listings,raster,skins}
  \newtcblisting{listing-tex}{
    listing and text,
    listing options={language=Tex, style=tcblatex}
  }
#+end_src

#+begin_src latex
  \ExplSyntaxOn
  \file_input:n{../tex/erw-counter.sty}
  \ExplSyntaxOff
  \CounterSetup{ new = foo }
#+end_src

#+begin_src latex
  \begin{document}
#+end_src

#+begin_src latex
  \begin{listing-tex}
    % \ExplSyntaxOn
    % \file_input:n{../tex/erw-counter.sty}
    % \ExplSyntaxOff
    % \CounterSetup{ new = foo }

    % Expected: 0
    Initial value: \CounterUse{foo}

    % Expected: 5
    Final value: \CounterRef{foo}{final}

    \CounterIncrement{foo}
    \CounterIncrement{foo}
    \CounterIncrement{foo}

    % Expected: 3
    Value after 3 increments: \CounterUse{foo}

    \CounterIncrement{foo}
    \CounterIncrement{foo}
    \CounterLabel{foo}{final}
  \end{listing-tex}
#+end_src

#+begin_src latex
  \end{document}
#+end_src
** biblatex
*** source
**** section
***** info

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % Info:
  % - In text citation template exposing a keys interface
#+end_src

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % - In the preamble:
  %  `\DeclareInstance{erw-biblatex}{default}{standard}
  %   { cite = { <code> } }`,
  %   where <code> is in terms of #1, #2, and #3,
  %   representing prenote, postnote, and key.
#+end_src

#+header: :noweb-ref tex-biblatex-info
#+begin_src latex
  % - In the document:
  %   `\BiblatexCite[<instance>]
  %   { key = <key>, prenote = <prenote>, postnote = <postnote> }`
#+end_src

***** guard

#+header: :noweb-ref tex-biblatex-guard
#+begin_src latex
  \tl_if_exist:NTF \g__erw_biblatex_flag_tl
  {%
    \msg_warning:nnn { __erw_biblatex }{ generic }{ already-loaded }
    \file_input_stop:
  }
  {%
    \tl_gset:Nn \g__erw_biblatex_flag_tl{}
  }
#+end_src
***** biblatex

#+header: :noweb-ref tex-biblatex-biblatex
#+begin_src latex
  \DeclareCiteCommand{\__erw_citeauthorfull}
  {}
  {\printnames[given-family][1-1]{author}}
  {}
  {}
#+end_src

***** expl3

#+header: :noweb-ref tex-biblatex-expl3
#+begin_src latex
  \makeatletter
  % should this be a const?
  \tl_const:Nx \c__erw_biblatex_bbxfile_tl { \blx@bbxfile }
  \makeatother
#+end_src

#+header: :noweb-ref tex-biblatex-expl3
#+begin_src latex
  \msg_new:nnn{__erw_biblatex}{generic}{#1}
#+end_src

#+header: :noweb tex-biblatex-expl3
#+begin_src latex
  % Warning no longer needed
  % \msg_warning:nnn{__erw_biblatex}{generic}
  % {Add~to~your~preamble~inside~expl3~syntax~mode:
  %   \makeatletter
  %   \tl_const:Nx \c__erw_biblatex_bbxfile_tl { \blx@bbxfile }
  %   \makeatother
  % }  
#+end_src

#+header: :tangle no
#+begin_src latex
  % \AtBeginDocument{%
  % \typeout{blx@cbxfile: \meaning\blx@cbxfile}
  % \typeout{blx@bbxfile: \meaning\blx@bbxfile}
  % }
#+end_src

#+header: :noweb-ref tex-biblatex-expl3
#+begin_src latex
  \prg_new_conditional:Npnn \__erw_biblatex_numeric: { TF }
  {
    \bool_lazy_or:nnTF
    { \str_if_eq_p:Vn \c__erw_biblatex_bbxfile_tl { numeric } }
    { \str_if_eq_p:Vn \c__erw_biblatex_bbxfile_tl { numeric-comp } }
    { \prg_return_true: }
    { \prg_return_false: }
  }
#+end_src

#+header: :noweb-ref tex-biblatex-expl3
#+begin_src latex
  \prop_new:N\g__erw_biblatex_prop
  \keys_define:nn{__erw_biblatex}
  {
    key.prop_gput:N = \g__erw_biblatex_prop,
    key.default:n = {\c_novalue_tl},
    prenote.prop_gput:N = \g__erw_biblatex_prop,
    prenote.default:n = {\c_empty_tl},
    postnote.prop_gput:N = \g__erw_biblatex_prop,
    postnote.default:n = {\c_empty_tl},
  }
#+end_src

#+header: :noweb tex-biblatex-expl3
#+begin_src latex
  \keys_set:nn{__erw_biblatex}{ key, prenote, postnote }
#+end_src

***** template

#+header: :noweb-ref tex-biblatex-template
#+begin_src latex
  \DeclareObjectType{erw-biblatex}{1}
  \DeclareTemplateInterface{erw-biblatex}
  { standard }{1}
  {
    cite : function{3},
  }
#+end_src

#+header: :noweb-ref tex-biblatex-template
#+begin_src latex
  \cs_new:Nn
  \__erw_biblatex_helper:nnnN
  {#4{#1}{#2}{#3}}
  \cs_generate_variant:Nn\__erw_biblatex_helper:nnnN{eee,ffe}
#+end_src

#+header: :noweb-ref tex-biblatex-template
#+begin_src latex
  \DeclareTemplateCode{erw-biblatex}
  { standard }
  {1}
  {
    cite = \__erw_biblatex_cite:nnn,
  }
  {%
    \AssignTemplateKeys
    
    \keys_set:nn{__erw_biblatex}{#1}

    \group_begin:

    \exp_args:NNe
    \tl_set:Nn\l_tmpa_tl
    { \prop_item:Nn\g__erw_biblatex_prop{key} }

    \exp_args:Ne
    \tl_if_novalue:nTF{\l_tmpa_tl}
    {%
      \msg_warning:nnn{__erw_biblatex}{generic}{bibliography~key~not~set}
    }
    {%
      \__erw_biblatex_helper:ffeN
      { \prop_item:Nn\g__erw_biblatex_prop{ prenote } }
      { \prop_item:Nn\g__erw_biblatex_prop{ postnote } }
      { \l_tmpa_tl }
      \__erw_biblatex_cite:nnn
    }
    
    \group_end:

    \keys_set:nn{__erw_biblatex}{ key, prenote, postnote }
    
  }
#+end_src

***** instance

#+header: :noweb-ref tex-biblatex-instance
#+begin_src latex
  \DeclareInstance{erw-biblatex}{default}{standard}
  {
    cite = { \cite[#1][#2]{#3} }
  }
#+end_src

#+header: :noweb-ref tex-biblatex-instance
#+begin_src latex
  \DeclareInstance{erw-biblatex}{author-num}{standard}
  {
    cite = { \__erw_citeauthorfull{#3}\cite[#1][#2]{#3} }
  }
#+end_src

#+header: :noweb-ref tex-biblatex-instance
#+begin_src latex
  \DeclareInstance{erw-biblatex}{title-num}{standard}
  {
    cite = { \citetitle{#3}\cite[#1][#2]{#3} }
  }
#+end_src

***** document

#+header: :noweb-ref tex-biblatex-doc-cmd
#+begin_src latex
  \ProvideDocumentCommand{\BiblatexCite}{O{default}m}
  {%
    \tl_if_regex_match:nnTF { #1 }{ -num$ }
    {%
      \__erw_biblatex_numeric:TF
      {}
      {%
        \exp_last_unbraced:Ne
        \msg_warning:nnnn{{__erw_biblatex}{generic}
          { \tl_to_str:N\c__erw_biblatex_bbxfile_tl~\c__erw_biblatex_bbxfile_tl~inconsistent~with~template~`#1`}
          {Use~ \tl_to_str:N\c__erw_biblatex_bbxfile_tl~`numeric`~or~`numeric-comp`}}
      }
    }{}
    % 
    \UseInstance{erw-biblatex}{#1}{#2}
  }
#+end_src

**** tangle
:PROPERTIES:
:header-args: :tangle ../tex/erw-biblatex.sty
:END:

#+header: :noweb yes
#+begin_src latex
  <<tex-license>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  <<tex-biblatex-info>>
#+end_src

#+begin_src latex
  \ExplSyntaxOn
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- guard
  <<tex-biblatex-guard>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- expl3
  <<tex-biblatex-expl3>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- biblatex
  <<tex-biblatex-biblatex>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- template
  <<tex-biblatex-template>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- instance
  <<tex-biblatex-instance>>
#+end_src

#+header: :noweb yes
#+begin_src latex
  % --- document command
  <<tex-biblatex-doc-cmd>>
#+end_src

#+begin_src latex
  \ExplSyntaxOff
#+end_src

*** example
:PROPERTIES:
:header-args: :tangle ../tex/example-biblatex.tex
:END:

#+begin_src latex
    \documentclass{article}
    % \usepackage[style=authoryear]{biblatex}
    \usepackage[style=numeric-comp]{biblatex}
    \addbibresource{../tex/biblatex-examples.bib}
#+end_src
    
#+begin_src latex
    \usepackage{lipsum,xtemplate,tcolorbox}
    \tcbuselibrary{listings}
    \newtcblisting{listing-tex}
    { listing options = { language = Tex, style = tcblatex } }
#+end_src
    
#+begin_src latex
  \input{../tex/erw-biblatex.sty}
#+end_src
    
#+begin_src latex
  \begin{document}
#+end_src
    
#+begin_src latex
  \begin{listing-tex}
    %\usepackage[style=numeric-comp]{biblatex}
    %\addbibresource{../tex/biblatex-examples.bib}
    % \input{../tex/erw-biblatex.sty}
    \section{Fancy quotes}

    \noindent\lipsum[1][1]\\
    ---~\BiblatexCite[author-num]{ key = aristotle:anima }

    \vspace{1em}

    \noindent\lipsum[1][2]\\
    ---~\BiblatexCite[title-num]{ key = aristotle:anima, postnote = {413a3-10} }

    \section{References}
    \printbibliography[heading=none]

  \end{listing-tex}
#+end_src
    
#+begin_src latex
  \end{document}
#+end_src

