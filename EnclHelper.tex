%----------------------------------------------------
% Source:
%       https://github.com/rogard/helpers.tex
% Usage:
%       \newcounter{encl}
%       \input{EnclHelper}
%       \EnclListOf{<entry>}{<listofnames>}                        
%       \EnclAddContentsLine*{<entry>|<kind>|<title>}     
%       \EnclLabel{<entry>}{<label>}     
%       \EnclAutoref{<entry>}{<suffix>}
%
% Credits:
%       https://tex.stackexchange.com/questions/523671/bind-a-label-to-newwatermark-refactoring-macros-defined-with-newcommand
%       https://tex.stackexchange.com/questions/524037/converting-an-argument-to-lower-case-in-expl3-context/524048?noredirect=1#comment1325909_524048
%----------------------------------------------------
\usepackage{pdfpages}
\usepackage{refcount}
\usepackage{tocloft}
\usepackage{xparse}
\usepackage{hyperref}

\ExplSyntaxOn

\ifcsundef{EnclHelperFlag}
{
  
% ERW-L3
\cs_new_protected:Nn \__erw_addcontentsline:nnn % add to erw-l3
{
  \addcontentsline{#1}{#2}{#3}
}
\cs_generate_variant:Nn \__erw_addcontentsline:nnn {enn}

\cs_new:Nn\__erw_autoref:n % todo erw-l3
{
  \autoref{#1}
}
\cs_generate_variant:Nn \__erw_autoref:n{e}
\cs_new:Nn\__erw_bgetpagerefnumber:n
{
  % https://tex.stackexchange.com/a/450783/112708
  \getpagerefnumber{\detokenize{#1}}
}

\cs_new:Nn\__erw_label:n
{
  \label{#1}
}
\cs_generate_variant:Nn \__erw_label:n{e}

% BACKEND
\cs_new_protected:Nn \__erw_encl_newlistof:nnn %todo erw-l3
{%
  \newlistof{#1} % entry
  {#2} % ext
  {#3} % listofname
}
\cs_generate_variant:Nn \__erw_encl_newlistof:nnn { ne }
\cs_new_protected:Nn \__erw_encl_newlistof:nnnn
 {%
  \newlistof[#1]{#2}{#3}{#4}
 }
\cs_generate_variant:Nn \__erw_encl_newlistof:nnnn { nne }
\cs_new_protected:Nn \__erw_encl_listof:n
{
  \exp_args:Nf \use:c{\tl_trim_spaces:n{listof#1}}
}

\cs_new:Nn\__erw_encl_addcontentsline:nnn
{

  \refstepcounter{encl}
  \__erw_addcontentsline:enn
%  {\str_lower_case:n{#1}}  % file
  {#1}  % file
  {#2}  % kind
  {\theencl.~\detokenize{#3}}
}

\cs_new:Nn\__erw_encl_label_inp:nn
{
  \tl_trim_spaces:n{#1:#2}
}
\cs_new:Nn\__erw_encl_label_inp:nnnn
{
  \__erw_encl_label_inp:nn{#1}{#4}
}
\cs_new:Nn\__erw_encl_label:nnnn
{
  \__erw_label:e{\__erw_encl_label_inp:nnnn{#1}{#2}{#3}{#4}}
}
\cs_generate_variant:Nn \__erw_encl_label:nn {e}
\cs_new:Nn\__erw_encl_autoref:nn
{
  \__erw_autoref:e{\tl_trim_spaces:n{#1:#2}}
%  \__erw_autoref:e{\__erw_encl_label_inp:nn{#1}{#2}}
}

 %FRONT END

\NewDocumentCommand{\EnclNewListOf}{omm}
{
  \__erw_encl_newlistof:nnen { #1 } { #2 }
  {
    % \str_lower_case:n { #2 }
    #2
  } { #3 }
}
\NewDocumentCommand{\EnclListOf}{m}
{
  % \todo why must come after begin{document}?
  % 
  \__erw_encl_listof:n{#1}
}

\NewDocumentCommand{\EnclAddContentsLine} 
{
  s
  O{|}
%  >{\SplitArgument{2}{#2}}m\todo
  >{\SplitArgument{2}{|}}m
}
{
  \IfBooleanT{#1}
  {\__erw_addcontentsline:nnn#3}
  {\__erw_encl_addcontentsline:nnn#3}
}

\NewDocumentCommand{\EnclLabel}
{mm}
{
  \__erw_label:nn{#1}{#2}
}

\NewDocumentCommand{\EnclAutoref}
{mm}
{\__erw_encl_autoref:nn{#1}{#2}}

  \def\EnclHelperFlag{}

}
{
  % do nothing
}

\ExplSyntaxOff