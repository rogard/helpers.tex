%--------------------------------------------------------------------------------
% Source:
%       https://github.com/rogard/helpers.tex
% Usage:
% 	\HelperBindOptionsSet
%		+<tag>+
%       	{<\cmd>}
%       	[<options>]
%       \HelperBindOptions
%		+<tag>+
%		[<opt>]
% Side effect:
%	\cmd[options,opt]
% License:
%	LaTeX Project Public License v1.3c or later
%--------------------------------------------------------------------------------
%\documentclass{report} % TEST
\usepackage{etoolbox}
%\usepackage{mwe} % TEST
%\usepackage{pdfpages} % TEST
\usepackage{xparse}
\ExplSyntaxOn

\ifcsundef{HelperBindOptionsFlag}
{

% BACKEND

\cs_new_protected:Nn \__erw_bind_options_set:nNn
{
  \tl_gset_eq:cN{__erw_bind_options_#1_cmd}#2
  \prop_gclear:c{__erw_bind_options_#1_opt}
  \prop_gset_from_keyval:cn{__erw_bind_options_#1_prop}{#3}
}
\cs_generate_variant:Nn \__erw_bind_options_set:nNn {nNe}
\cs_new_protected:Nn \__erw_bind_options_copy:Nn
{
  % TODO erw-l3?
  \prop_map_inline:cn
  {__erw_bind_options_#2_prop}
  {\seq_put_right:Nn #1{##1=##2}}
}
\cs_new_protected:Nn \__erw_bind_options_concat:nnN 
{
  \seq_clear:N \l_tmpa_seq
  \__erw_bind_options_copy:Nn \l_tmpa_seq{#1}  
  \seq_set_from_clist:Nn \l_tmpb_seq{#2}
  \seq_concat:NNN #3 \l_tmpa_seq \l_tmpb_seq
}
\cs_new_protected:Nn\__erw_bind_options_eval:Nn{#1[#2]}
\cs_generate_variant:Nn \__erw_bind_options_eval:Nn {cx}
\cs_new_protected:Nn\__erw_bind_options_eval:nn
{
  \seq_clear:N \l_tmpc_seq
  \__erw_bind_options_concat:nnN{#1}{#2}\l_tmpc_seq
  \__erw_bind_options_eval:cx{__erw_bind_options_#1_cmd}{\seq_use:Nn \l_tmpc_seq{,}}
}
  
%FRONTEND

\NewDocumentCommand\BindOptionsSet{D++{Default}mO{}}
{\__erw_bind_options_set:nNn{#1}#2{#3}}

\NewDocumentCommand\BindOptionsEval{D++{Default}O{}}
{\__erw_bind_options_eval:nn{#1}{#2}}

  \def\HelperBindOptionsFlag{}

}
{
  % do nothing
}

\ExplSyntaxOff
%% TEST (continued) 	>>
%\begin{document}
%
%%\BindOptionsSet{\includepdf}[angle=45, scale=0.85]
%%\BindOptionsEval[scale=0.25]{example-image-a}
%
%\BindOptionsSet+Pdf+{\includepdf}[angle=45, scale=0.85]
%\BindOptionsEval+Pdf+[scale=0.25]{example-image-a}
%
%%			<<
\end{document}
